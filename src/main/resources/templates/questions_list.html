<html layout:decorate="~{layout}"><!--공용 레이아웃 추가-->
<div layout:fragment="content" class="container my-3">
    <div class="row my-3">
        <div class="col-6">
            <button class="categoryButton" onclick="updateCategory('free')">자유 게시글</button>
            <button class="categoryButton" onclick="updateCategory('ask')">질문 게시글</button>
            <button class="categoryButton" onclick="updateCategory('notice')">공지 게시글</button>
        </div>
        <div class="col-6">
            <a th:href="@{/questions/create}" class="btn btn-primary">질문 등록하기</a>
        </div>
        <div class="col-6">
            <div class="input-group">
                <input type="text" id="search_kw" class="form-control" th:value="${kw}">
                <button class="btn btn-outline-secondary" type="button" id="btn_search">찾기</button>
            </div>
        </div>
    </div>
    <table class="table">
        <thead class="table-dark">
        <tr class="text-center">
            <th>번호</th>
            <th style="width:50%">제목</th>
            <th>글쓴이</th>
            <th>작성일시</th>
            <th>조회수</th>
        </tr>
        </thead>

        <tbody id="questions-list">
        <!-- 여기서 JavaScript를 통해 질문 목록을 동적으로 추가 -->
        </tbody>
    </table>
    <div class="text-center my-3">
        <button id="load-more" class="btn btn-primary">더보기</button>
    </div>
</div>
<script layout:fragment="script" type='text/javascript'>
let currentPage = 0;
        let currentCategory = '';
        let currentKeyword = '';
        let loading = false;

        function loadQuestions(page, kw = '', category = '') {
            if (loading) return;
            loading = true;

            fetch(`/api/questions?page=${page}&kw=${kw}&category=${category}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    if (page === 0) {
                        // 첫 페이지 로드 시 기존 리스트를 비웁니다.
                        document.getElementById('questions-list').innerHTML = '';
                    }
                    displayQuestions(data.content);
                    loading = false;

                    // 더 이상 로드할 데이터가 없으면 "더보기" 버튼 숨김
                    if (data.content.length === 0) {
                        document.getElementById('load-more').style.display = 'none';
                    } else {
                        document.getElementById('load-more').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading = false;
                });
        }

        function displayQuestions(questions) {
            const listElement = document.getElementById('questions-list');
            questions.forEach(question => {
                const item = document.createElement('tr');
                item.className = 'text-center';
                item.innerHTML = `
                    <td>${question.uploadnumber}</td>
                    <td class="text-start">
                        <a href="/questions/detail/${question.uploadnumber}">${question.title}</a>
                        <span class="text-danger small ms-2">${question.replysList.length > 0 ? question.replysList.length : ''}</span>
                    </td>
                    <td>${question.author ? question.author.username : ''}</td>
                    <td>${new Date(question.nowtime).toLocaleString()}</td>
                    <td>${question.view}</td>
                `;
                listElement.appendChild(item);
            });
        }

        function updateCategory(category) {
            currentCategory = category;
            currentPage = 0;
            loadQuestions(currentPage, currentKeyword, currentCategory);
        }

        document.getElementById('btn_search').addEventListener('click', function() {
            currentKeyword = document.getElementById('search_kw').value;
            currentPage = 0;
            loadQuestions(currentPage, currentKeyword, currentCategory);
        });

        document.getElementById('load-more').addEventListener('click', function() {
            currentPage++;
            loadQuestions(currentPage, currentKeyword, currentCategory);
        });

        // 페이지가 로드될 때 초기 데이터를 로드합니다.
        loadQuestions(currentPage);

</script>
</html>